# Customisation

## User consent with 3rd party applications
* Limitations
  * OIDC support only
* Ability to use Auth0 as an identity provider for 3rd party applications e.g. (results in consent prompt)
  ```http request
  GET /authorize
  ?client_id=some_third_party_client
  &redirect_uri=https://fabrikam.com/contoso_social (redirected to in case of decline and end of login flow)
  &response_type=token id_token
  &__scope=openid profile email read:posts write:posts__
  &__audience=https://social.contoso.com__
  &nonce=...
  &state=...
  ```
* Consent prompt
  * Appears when users request scopes for 3rd party applications
    * Scope descriptions can be customised for the API those scopes are requested for on permissions tab
      * However requires enabling use_scope_descriptions_for_consent flag at tenant level settings
  * 'Allow Skipping User Consent'
    * Can skip consent for first party applications with
    * Only verifiable first parties
    * apps > apis > settings > access settings
    * Enabled by default
  * 3rd party Auth will always result in Consent prompt e.g.
    * Hi User@gmail.com, 3rd party application is requesting access to your Auth0 profile and email bla bla bla. Accept/Decline
  * Revoke user's consent to app
    * dashboard > user management > users > Authorized Applications > Revoke (next to App)
  * Password flows - no consent provided as you have user password so assumption of full access is already assumed
  * Force consent (even for 1st party) - /authorize?prompt=consent

## Branding

### Set up Branding

### Customize email handling, and setup email providers
* Limitations - email provider must provide
  * TLS 1.2 and above
  * SMTP Auth with login protocol - otherwise use an ACTION
  * CA signed by public certificate authority
  * Allow inbound connections from Auth0 addresses
  * Microsoft Exchange Online support retiring basic auth for SMTP AUTH - need to use marketplace integration to get around this
* Dashboard or management API
  * Dashboard - Branding > Email Providers
  * Management API - /api/v2/emails/provider

### Configure custom domain for authentication
* Must change CNAME record to allow mapping to Auth0
  * Recommended: Auth0 IPs can change. Add your custom domain to the Auth0 AllowList instead
* iss - on token will include your custom domain
* Benefits
  * Brand loyalty
  * Application maintenance - centralise authentication services
  * Phishing resistant - attackers have to create urls that mimic yours. Much harder when not a machine generated domain
* Location - dashboard > branding > Custom Domains
* Certificates
  * Auth0 managed - renews every 3 months automatically
  * Self managed
    * Enterprise tier only 
    * Reverse proxy required - Auth0 does SSL handshake with a proxy that you provide, not the end user's browser
    * you must provide Auth0 with the header `cname-api-key` to validate that the domain belongs to you
* Limitations
  * Changing domain will invalidate all existing sessions
  * Features that support custom domains
    * Universal Login
    * MFA / Guardian
    * Emails
    * Connections
    * Lock
    * Passwordless
    * SAML
    * WS-Federation
    * OAuth 2.0/OIDC compliant flows

### Customize Email templates using Liquid Syntax
* Limitations
  * no access to client metadata variables 
  * Redirect URL does not have access to Auth0 template variables
  * Must provide custom external email provider
  * Each email has one template - multiple brands have to be customised in same template
  * HTML only, not plain text support
  * MFA enrollment template connection.name is not available
  * Passwordless OTP email template 
    * only user.email of user profile is available
    * customisation available in different location in dashboard > Authentication > Passwordless
  * Using @auth0.com in **FROM** field - removes all customisation, only defaults used 
* Uses Liquid templating language
  * See customisable pages below for more detail

### Customize Login pages, Consent prompts, and Error pages

#### Customisable pages
* Limitations
  * Universal Login only 
  * Must have a custom domain and must use then when redirecting to {customDomain}/authorize
  * Cannot override Auth0 CSS as it's dynamically created each build
    * Workarounds via liquid template (very limited)
      * --prompt-width - adjust container width
      * --form-max-width - max form width
      * --font-family - font family
      * use class _hide-prompt-logo in **body** tag to hide logo
      * _use-custom-prompt-logo in **body** tag to use custom logo
      * _widget-auto-layout in **body** tag to centre prompt
      * e.g. 
      ```liquid
      <!DOCTYPE html>
      <html lang="{{locale}}">
      
        <head>
          <title>Welcome to {{ application.name }} </title>
          {%- auth0:head -%}
          <style>
            :root {
              --prompt-width: 800px;
            }
            {% if application.name == "Auth0 Community" %}
            #custom-prompt-logo {
            background-image: url('https://cdn.auth0.com/manhattan/versions/1.3312.0/assets/badge.png');
            }
            {% elsif application.name == "Auth0 Dashboard" %}
            #custom-prompt-logo {
            background-image: url('https://cdn.auth0.com/blog/auth0rta/theme/logos/auth0-logo-black.png');
            }
            {% endif %}
        </style>
      
        </head>
      
        <body class="_widget-auto-layout _use-custom-prompt-logo">
          {%- auth0:widget -%}
        </body>
      
      </html>
      ```
  * Page structure could change in future so avoid or reduce customisation as much as possible
* Uses Liquid templating language
    ```html
    <!DOCTYPE html>
    {% assign resolved_dir = dir | default: "auto" %}
    <html lang="{{locale}}" dir="{{resolved_dir}}">
      <head>
        {%- auth0:head -%}
      </head>
      <body class="_widget-auto-layout">
        {%- auth0:widget -%}
      </body>
    </html>
    ```
  * Key features
    * {% auth0:head %} - contains tags required for rendering the prompt (specific step in login flow)
    * {% auth0:widget %} - Contains HTML for the prompt displayed on every page of the login flow, such as the Login page or Reset Password page
    * Styling - _widget-auto-layout - special class to centre prompt on page (only works on body)
  * Limitations
    * Storybook support - <script> tags break the rendering. As a workaround use (`) e.g.
      * `<scr`+`ipt>console.log("test");</scr`+`ipt>`
* Template variables
  * Benefits
    * great for customising different brands
    * render different content based on prompt
    * Add footers
  * Available variables types
    * Application
      * application.id - client ID
      * application.name - application name
      * applicaiton.logo_url - application logo URL
      * application.metadata - application metadata associated with user profile
    * Branding
      * branding.logo_url - application logo URL
      * branding.colors.primary - primary branding colour #000000
      * branding.colors.page_background - background colour of login page #FFFFFF
    * Tenant
      * tenant.friendly_name - tenant display name
      * tenant.support_email - support email address
      * tenant.support_url - support URL
      * tenant.enabled_locales - comma separated list of enabled locales
    * Organisations
      * organization.id - organisation ID
      * organization.name - organisation name
      * organization.display_name - organisation display name
      * organization.metadata - organisation metadata - same as application metadata, just key value pairs for organisation
      * organization.branding.logo_url - organisation logo URL
      * organization.branding.colors.primary - organisation primary branding colour #000000
      * organization.branding.colors.page_background - organisation background colour of login page #FFFFFF
    * Current user information
      * user.user_id - user ID
      * user.picture - URL of the user's profile picture
      * user.email - user email address
      * user.email_verified - Boolean indicationg whether the user's email address has been verified
      * user.user_metadata - user metadata associated with user profile
      * user.family_name - user family name
      * user.given_name - user given name
      * user.name - user full name
      * user.nickname - user nickname
      * user.username - user username
    * Current screen information
      * dir - indicates direction of the elements text (auto, ltr or rtl)
      * locale - indicates the language of the elements text e.g. en-US
      * prompt.name - name of the prompt e.g mfa
      * prompt.screen.name - name of currently rendered screen e.g. mfa-login-options
      * prompt.screen.texts - object containing all the text for the currently rendered screen e.g. `{"pageTitle": "Verify your identity"}`
* Customisable query parameters (VERY COOL)
  * You can also add query parameters that get passed to the page template using the `ext-` prefix
    * /authorize?ext-custom-text=sometext
    * Limitations
      * must be unique
      * 10 max per /authorize call
      * name - [a-zA-z0-9_-] with a max of 28 chars - e.g /^ext-[\w-]{1,28}$/
      * value - [a-zA-Z0-9-.*~@+ /:_] with a max of 255 chars e.g. /^[-\w.*~@+ /:]{1,255}$/
* Customise page template via API
  * Scopes: update:branding; read:branding; delete:branding
  * Max body size: 100KB. If exceeded, consider moving assets outside of page template code
  * Post example
    ```bash
    curl --request PUT \
      --url 'https://{yourDomain}/api/v2/branding/templates/universal-login' \
      --header 'authorization: Bearer MGMT_API_ACCESS_TOKEN' \
      --header 'content-type: text/html' \
      --data '<!DOCTYPE html><html><head>{%- auth0:head -%}</head><body>{%- auth0:widget -%}</body></html>'
    ```
    
## Actions and Extensions
* EXCELLENT RESOURCE FOR MANY EXAMPLES AND USE CASES TO COPY FROM
  * https://auth0.com/docs/customize/actions/use-cases
* Features
  * Synchronous or Asynchronous
  * Multiple actions per trigger
  * Can be versioned
  * Written in Node.js - pull access to npm public registry
  * Logging - all actions outputs goto Auth0 logs
* Types
  * Sign up and login triggers
    * pre-user-registration - triggers before a user is created
    * post-user-registration - triggers asynchronously after a user is created
  * MFA Notification triggers
    * send-phone-message - Triggers when using a custom provider to send the messages for the enrollment and the challenge process
  * Password reset triggers
    * post-change-password - Triggers after a user changes their password
    * password-reset-post-challenge - triggers after the first challenge is completed and before the password is reset
  * Machine to Machine triggers
    * credentials-exchange - Triggers before an access token is returned
  * Custom token exchange trigger
    * custom-token-exchange - Triggers at first step for the transaction, before the post-login trigger
* Main parameters
  * event - object for post-login actions triggers that provides contextual information about a single user logging in via Auth0
    * Full breakdown of event object can be found [here](https://auth0.com/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-event-object)
  * api - object for actions that allows you to: manipulate tokens and user profiles; deny access to applications;
    * Full breakdown of api object can be found [here](https://auth0.com/docs/customize/actions/explore-triggers/signup-and-login-triggers/login-trigger/post-login-api-object)

### Examples
#### Allow access only on weekdays for a specific application
* Login / Post login Action
```javascript
exports.onExecutePostLogin = async (event, api) => {
  if (event.client.name === "APP_NAME") {
    const d = new Date().getDay();

    if (d === 0 || d === 6) {
      api.access.deny("This app is only available during the week.");
    }
  }
}
```

### Implement profile enrichment
* API Management - Patch users by id e.g.
  ```bash
  curl -L -g -X PATCH 'https://{tenantDomain}/api/v2/users/:id' \
  -H 'Content-Type: application/json' \
  -H 'Accept: application/json' \
  --data-raw '{"blocked":false,"email_verified":false,"email":"user@example.com","phone_number":"string","phone_verified":false,"user_metadata":{},"app_metadata":{},"given_name":"string","family_name":"string","name":"string","nickname":"string","picture":"string","verify_email":false,"verify_phone_number":false,"password":"string","connection":"string","client_id":"string","username":"string"}'
  ```
* Action - Add user roles to tokens - Login / Post login Action
  ```javascript
  exports.onExecutePostLogin = async (event, api) => {
    const namespace = 'https://my-app.example.com';
    if (event.authorization) {
      api.idToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
      api.accessToken.setCustomClaim(`${namespace}/roles`, event.authorization.roles);
    }
  }
  ```
  
### Implement IP-based access restrictions
* Login / Post login Action
```javascript
const ipaddr = require("ipaddr.js");

exports.onExecutePostLogin = async (event, api) => {
  const corpNetwork = "192.168.1.134/26";
  const currentIp = ipaddr.parse(event.request.ip);

  if (!currentIp.match(ipaddr.parseCIDR(corpNetwork))) {
    api.access.deny("This app is only available from inside the corporate network.");
  };
};
```

### Invoking third party APIs with actions (identify use cases)
* Just use axios or a similar library
  * e.g. send email to sendgrid or email server after password change

### Integrate and explain extensions (apps from marketplace)
* Rules & Hooks are deprecated so don't use them
* Allow you to install applications, scripts/commands that extend the existing functionality of Auth0 base product
* Main Extensions
  * Authorization Extension	How to use the extension to control user authorization behavior during runtime
  * Delegated Administration Extension - expose the Users section of the Auth0 Dashboard to a select group of users without allowing them access to the rest of the Dashboard
  * Single Sign-On Dashboard Extension - manage single sign-on login for your users on multiple enterprise applications
  * Authentication API Debugger Extension - use the Authentication API Debugger to test various endpoints
  * AD/LDAP Connector - use the AD/LDAP Connector extension to access on-premises Active Directory or LDAP servers
  * Account Link Extension - use the account link extension
  * User Import/Export Extension - user import/export extension
  * Export Log Events with Extensions - export logs to third-party services such as Application Insights, Loggly, and MixPanel.

### Customize error messages

### Design and implement user group management

### Implement extensibility using actions