# Security

## Implement multi-factor authentication policies
* Location: Dashboard > Security > Multifactor Authentication
* Note: First factor logins do not require MFA
  * e.g. Passwordless and Passkeys are all considered first factor or independent
* Independent Factors do not require other MFA factors
* Independent Factors
  * Push notifications (Guardian app only)
  * SMS notifications
  * Voice notifications
  * One time passwords (OTP)
  * Cisco Due security
  * WebAuthn with security keys - e.g. Yubikey, Google Titan
* Dependent factors 
  * Recovery codes
  * WebAuthn with biometrics
  * Email notifications
* Defaults
  * Auth0 presents the most secure authentication factors to users upon enrollment. 
    To disable it, toggle on 'Show Multi-factor Authentication options'
* Actions - can allow MFA per user or application
* Adaptive MFA (enterprise only)
  * NOTE: for some reason Auth0 doesn't count this as Step-up Auth but we all know it is, just based on risk
  * Options
    * On - MFA when high risk login activity is detected
    * Always - MFA is always required
    * Never - MFA is never required
  * Limitations
    * Pain in the arse to test as you never know when it will kick in
    * Score based on
      * New Device - not been used in 30 days
      * ImpossibleTravel - user attempted to login from location that would be impossible to travel to since last login
      * UntrustedIP - IP thats on a list bad behaviour list
    * If not enrolled in MFA user gets email challenge
    * Not supported for
      * Basically any flows that do not make email available like passwordless SMS and some of the following
      * Client credentials flow
      * Device Authorisation flow (unless using Universal login)
      * Resource owner flow (unless you use auth0-forwarded-for header)
      * SAML IdP initiated login
      * Only available for social connections that provide an email address (to allow alternative MFA flow)
* Step up Authentication
  * Reasons
    * limit access to parts of website for paying users
    * require higher level of assurance when users attempt to access sensitive resources
  * 'Step up authentication' via webapp (Really bad approach - but simple to implement)
    1. User tries to do something risky like transfer funds
    2. App checks to see if they have logged in with MFA by reviewing claims in ID token
  * 'Step up authentication' via scopes with Actions
    * requires 
      * scopes, actions and access token
      * app registered; database connection; API registered; MFA enabled on tenant
      * validate tokens signature and standard claims
      * create post-login action to check user's ID Token for amr claim to have mfa
    * 'Customise MFA factors using actions' ensures verification logic will be available using extensible methods in actions
    1. Initial login asks for scope read:accounts
    2. User then want to do something risky like transfer:funds
    3. Check if ID token 'amr' claim equals 'mfa' (already passed MFA) - only works when not using RBAC and access token returns all scopes available
    4. If step 3 does apply and pass, flow ends here and app authorises using access token claims from initial login
       If step 3 doesn't apply - continue
    5. Needs to call /authorize with scope transfer:funds to ask for it
    6. Post-login Action intercepts this and asks for MFA
    * You can extend behaviour with action - Perform action if overall score is X
      ```javascript
      exports.onExecutePostLogin = async (event, api) => {
        const {riskAssessment} = event.authentication || {};
        const riskIsMedium = riskAssessment && riskAssessment.confidence === 'medium';
 
        if (riskIsMedium) {
            // ....
        }
      }     
      ```
* Management
  * B2B - Customers manage MFA for their users
  * B2C - End users manage MFA via profile page
  * B2E - Company (you) manage MFA for your users
* Get factors for user
  ```bash
  curl --request GET \
    --url 'https://{yourDomain}/mfa/authenticators' \
    --header 'authorization: Bearer MFA_TOKEN'
  ```

## Set up attack protection
### Brute-Force Protection
* Prevents brute force attacks from same IP address for a single user
* Location: Dashboard > Security > Attack Protection > Brute Force Protection
* Default: Enabled
* Has IP AllowList
* When blocked
  * IP added to blocked list
  * 429 response returned from now on
  * Sends notifications to affected users when detected
* When IP is blocked automatically it remains blocked until 
  * admin removes block
  * admin raises brute force threshold
  * 30 days passes
  * affected user selects unblock link in email notification (if configured)
  * affected user changes their password (on all linked accounts)
* Will run in monitoring mode if you do not specify a Response
* Responses
  * Block Brute-force login attempts - blocks IP address
  * Account Lock out - blocks account regardless of IP address
  * Send notification to affected users - SMS, EMail
* Special cases
  * Resource Owner password flow - requires setting auth0-forwarded-for header as all logins will appear to come from same server IP
  * Proxies & Shared IP Addresses (VPNs) - same issues as resource owner but you can whitelist these IP addresses using 
    a subnet range / CIDR range

## Configure password complexity rules
* See 'Database (Password)' in 2.authentication.md
  * Length, complexity
  * History - remembers up to last 24 passwords
  * Dictionary - can restrict users from using dumb passwords using an Auth0 password dictionary plus custom entries
  * Disallow personal data - can restrict users from using data from their profile

## Set up anomaly detection actions
* Add Auth0 actions to be triggered when anomalous login activity is detected - no information was available on this

## Implement CAPTCHA or reCAPTCHA
### Bot Detection
* Location: Dashboard > Security > Attack Protection > Bot Detection
  1. Enable Tenant logs for Risk Assessment
  2. Choose a response
  3. Choose when to prompt for CAPTCHA: Never, When Risk, Always
  4. Choose Bot Detection level: Low; Medium (default), High (secret sauce, Auth0 doesn't explain this)
* If you do not provide a response, then Bot Detection will just monitor. Good for trialling/testing
* Responses
  * Auth Challenge (Default)
    * Strong privacy and good user experience
    * Requires Javascript enabled in browser
  * Simple CAPTCHA
  * Google reCAPTCHA v2
  * reCAPTCHA Enterprise
  * hCaptcha
  * Friendly Captcha
  * Arkose Labs
* Detection Models (for Classic and custom login pages)
  * Ensure SDKs (Auth0.js, Lock) used are latest versions
* Limitations
  * Works for Universal Login
  * Classic and Custom Logins are mostly covered 
    * if using latest versions of Auth0.js and Lock
    * Not supported - if performing cross origin authentication
  * Regular web or native apps using resource owner password flow are not supported unless you trigger a web based 
    login flow to complete authentication and pass a captcha step 
  * Some connections are not supported
    * Enterprise
    * Social
    * Passwordless - supported if compatible web based flow is used (see limitations above)
    
## Set up password history and reuse policies
* See 'Database (Password)' in 2.authentication.md

## Set up passwordless authentication
* See 'Passwordless' and 'Biometrics in 2.authentication.md
* Requires 'Identifier first' Authentication profile
* After a user logs in with username/password and enroll their device, next time they just provide
  1. Their email address / username
  2. Prompted for biometrics login (or sent SMS or email for passwordless or passkey)